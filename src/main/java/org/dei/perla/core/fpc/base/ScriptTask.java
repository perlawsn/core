package org.dei.perla.core.fpc.base;

import org.dei.perla.core.engine.Executor;
import org.dei.perla.core.engine.Runner;
import org.dei.perla.core.engine.Script;
import org.dei.perla.core.engine.ScriptHandler;
import org.dei.perla.core.fpc.TaskHandler;
import org.dei.perla.core.record.Record;
import org.dei.perla.core.record.RecordPipeline;

import java.util.List;

/**
 * <p>
 * An object for controlling the asynchronous execution of a single
 * {@link Script}. {@code ScriptTask}s are used to control Set or Get operation;
 * as such, they terminate as soon as the associated {@link Script} stops.
 * </p>
 *
 * <p>
 * All {@link Record}s generated by the {@link Script} are notified to the
 * interested components through one or more invocations of the
 * {@link TaskHandler} passed as parameter.
 * </p>
 *
 * @author Guido Rota (2014)
 *
 */
public class ScriptTask extends AbstractTask {

	private final Runner runner;

	protected ScriptTask(OneoffOperation operation, TaskHandler handler,
			RecordPipeline pipeline) {
		super(operation, handler, pipeline);
		this.runner = Executor.execute(operation.getScript(),
				new OneoffScriptHandler());
	}

	@Override
	public void doStop() {
		runner.cancel();
	}

	/**
	 * Custom {@link ScriptHandler} used for collecting the results of the
	 * {@link Script} and for switching the {@code ScriptTask} state (running /
	 * not running).
	 *
	 * @author Guido Rota (2014)
	 *
	 */
	private class OneoffScriptHandler implements ScriptHandler {

		@Override
		public void complete(Script script, List<Record> recordList) {
			for (Record record : recordList) {
				processRecord(record);
			}
			notifyComplete();
		}

		@Override
		public void error(Throwable cause) {
			notifyError(cause, true);
		}

	}

}
